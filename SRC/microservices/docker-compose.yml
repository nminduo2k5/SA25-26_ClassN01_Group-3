version: '3.8'

services:
  # Gateway
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - price-predictor
      - investment-expert
      # Only depend on implemented services
      # - risk-expert
      # - news-agent  
      # - market-news
      # - stock-info

  # Shared Services
  redis:
    image: redis:alpine
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes

  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: vnstock_db
      POSTGRES_USER: vnstock
      POSTGRES_PASSWORD: vnstock123
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: vnstock
      RABBITMQ_DEFAULT_PASS: vnstock123

  # LLM Hub Service
  llm-hub:
    build: ./services/llm-hub
    ports:
      - "8010:8010"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - redis

  # Agent Services
  price-predictor:
    build: ./services/price-predictor
    ports:
      - "8001:8001"
    depends_on:
      - redis
      - postgres
      - llm-hub

  investment-expert:
    build: ./services/investment-expert
    ports:
      - "8002:8002"
    depends_on:
      - redis
      - postgres
      - llm-hub

  # Future services (not implemented yet)
  # risk-expert:
  #   build: ./services/risk-expert
  #   ports:
  #     - "8003:8003"
  #   depends_on:
  #     - redis
  #     - postgres
  #     - llm-hub

  # news-agent:
  #   build: ./services/news-agent
  #   ports:
  #     - "8004:8004"
  #   depends_on:
  #     - redis
  #     - postgres
  #     - llm-hub

  # market-news:
  #   build: ./services/market-news
  #   ports:
  #     - "8005:8005"
  #   depends_on:
  #     - redis
  #     - postgres
  #     - llm-hub

  # stock-info:
  #   build: ./services/stock-info
  #   ports:
  #     - "8006:8006"
  #   depends_on:
  #     - redis
  #     - postgres
  #     - llm-hub

  # Frontend
  frontend:
    build: ./services/frontend
    ports:
      - "8502:8501"
    depends_on:
      - nginx
    environment:
      - GATEWAY_URL=http://nginx

volumes:
  postgres_data: