version: '3.8'

services:
  # Development Application with Hot Reload
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: vnstock-app-dev
    ports:
      - "8501:8501"
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_FILE_WATCHER_TYPE=poll
      - STREAMLIT_SERVER_RUN_ON_SAVE=true
      - DEBUG=true
      - LOG_LEVEL=DEBUG
    volumes:
      - .:/app
      - ./logs:/app/logs
      - ./duong_trading.db:/app/duong_trading.db
      - ./cache:/app/cache
      - /app/__pycache__
    command: >
      sh -c "pip install -e . 2>/dev/null || true &&
             streamlit run app.py 
             --server.port=8501 
             --server.address=0.0.0.0 
             --server.fileWatcherType=poll
             --server.runOnSave=true"
    networks:
      - vnstock-dev
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Development Redis
  redis-dev:
    image: redis:7-alpine
    container_name: vnstock-redis-dev
    ports:
      - "6379:6379"
    command: redis-server --save "" --appendonly no
    networks:
      - vnstock-dev

  # Redis Commander for Development
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: vnstock-redis-ui
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=local:redis-dev:6379
    networks:
      - vnstock-dev
    depends_on:
      - redis-dev

networks:
  vnstock-dev:
    driver: bridge